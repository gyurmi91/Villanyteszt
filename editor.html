<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kérdésbank szerkesztő</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:18px; background:#0b1220; color:#e5e7eb;}
  .wrap{max-width:1100px; margin:0 auto;}
  .card{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:14px; margin-bottom:12px;}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;}
  label{font-size:12px; color:rgba(255,255,255,.72); font-weight:700;}
  input, textarea, select{background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.14); color:#e5e7eb; border-radius:12px; padding:10px; outline:none;}
  textarea{width:100%; min-height:120px; resize:vertical;}
  .btn{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); color:#e5e7eb; padding:10px 12px; border-radius:14px; font-weight:800; cursor:pointer;}
  .btn.primary{background:#2563eb; border-color:#1d4ed8;}
  .btn.danger{background:#ef4444; border-color:#dc2626;}
  .small{font-size:12px; color:rgba(255,255,255,.7);}
  .list{max-height:420px; overflow:auto;}
  .item{padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.10); margin-bottom:8px; cursor:pointer;}
  .item:hover{background:rgba(255,255,255,.05);}
  .item.sel{outline:2px solid #22c55e;}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div style="font-weight:900; font-size:18px;">Kérdésbank szerkesztő</div>
    <div class="small">Tölts be egy <span class="mono">questions.json</span>-t, szerkeszd, majd töltsd le az új verziót. (A képek útvonala maradjon relatív, pl. <span class="mono">assets/images/17.png</span>.)</div>
    <div class="row" style="margin-top:10px;">
      <div>
        <label>Fájl betöltése</label><br/>
        <input id="file" type="file" accept="application/json"/>
      </div>
      <button class="btn" id="loadDefault">Próbáld a mappában lévő questions.json-t</button>
      <button class="btn primary" id="download">Letöltés (questions.json)</button>
      <button class="btn danger" id="reset">Minden törlése</button>
    </div>
    <div class="small" id="status" style="margin-top:8px;"></div>
  </div>

  <div class="row">
    <div class="card" style="flex:1; min-width:320px;">
      <div style="font-weight:900;">Kérdések</div>
      <div class="row" style="margin-top:8px;">
        <div style="flex:1;">
          <label>Keresés</label><br/>
          <input id="search" type="text" placeholder="ID, téma, szöveg..." style="width:100%;"/>
        </div>
        <button class="btn" id="add">+ Új kérdés</button>
      </div>
      <div class="list" id="list" style="margin-top:10px;"></div>
    </div>

    <div class="card" style="flex:2; min-width:420px;">
      <div style="font-weight:900;">Szerkesztés</div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>ID (szám)</label><br/>
          <input id="qid" type="number" min="1" style="width:120px;"/>
        </div>
        <div style="flex:1;">
          <label>Téma</label><br/>
          <input id="topic" type="text" style="width:100%;"/>
        </div>
        <div>
          <label>Oldal</label><br/>
          <input id="page" type="number" min="0" style="width:120px;"/>
        </div>
        <div>
          <label>Pont</label><br/>
          <input id="points" type="number" min="0" style="width:120px;"/>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Kérdésszöveg</label>
        <textarea id="question" placeholder="Kérdés..."></textarea>
      </div>

      <div style="margin-top:10px;">
        <label>Válaszlehetőségek (soronként)</label>
        <textarea id="options" placeholder="1. opció\n2. opció\n..."></textarea>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1; min-width:240px;">
          <label>Helyes válasz(ok) (1-től indexelve, vesszővel)</label><br/>
          <input id="correct" type="text" placeholder="pl. 2 vagy 1,3" style="width:100%;"/>
        </div>
        <div style="flex:1; min-width:240px;">
          <label>Kép útvonal (opcionális)</label><br/>
          <input id="image" type="text" placeholder="assets/images/17.png" style="width:100%;"/>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Magyarázat (opcionális)</label>
        <textarea id="explanation" placeholder="Rövid magyarázat..."></textarea>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="save">Mentés</button>
        <button class="btn danger" id="del">Törlés</button>
        <div class="small" id="editStatus"></div>
      </div>
    </div>
  </div>
</div>

<script>
const el = (id) => document.getElementById(id);
let BANK = null;
let selIdx = -1;

function setStatus(msg){ el('status').textContent = msg || ''; }
function setEditStatus(msg){ el('editStatus').textContent = msg || ''; }

function normalizeBank(obj){
  if (Array.isArray(obj)) {
    return {generated_at: new Date().toISOString(), count: obj.length, topics: [], questions: obj};
  }
  if (!obj || typeof obj !== 'object') throw new Error('bad');
  if (!Array.isArray(obj.questions)) obj.questions = [];
  obj.count = obj.questions.length;
  obj.topics = Array.from(new Set(obj.questions.map(q => q.topic).filter(Boolean))).sort();
  return obj;
}

function renderList(){
  const list = el('list');
  list.innerHTML = '';
  if (!BANK) return;
  const term = (el('search').value || '').trim().toLowerCase();
  const qs = BANK.questions
    .map((q, i) => ({q, i}))
    .filter(x => {
      if (!term) return true;
      const hay = `${x.q.id} ${x.q.topic||''} ${x.q.page||''} ${x.q.question||''}`.toLowerCase();
      return term.split(/\s+/).every(t => hay.includes(t));
    })
    .slice(0, 600);
  for (const {q,i} of qs){
    const div = document.createElement('div');
    div.className = 'item' + (i === selIdx ? ' sel' : '');
    div.innerHTML = `<div><b>ID:</b> <span class="mono">${q.id}</span> • <span class="small">${(q.topic||'').slice(0,60)}</span></div>
                     <div class="small">${String(q.question||'').slice(0,120)}${String(q.question||'').length>120?'…':''}</div>`;
    div.addEventListener('click', () => { select(i); });
    list.appendChild(div);
  }
}

function select(i){
  selIdx = i;
  const q = BANK.questions[i];
  if (!q) return;
  el('qid').value = q.id ?? '';
  el('topic').value = q.topic ?? '';
  el('page').value = q.page ?? '';
  el('points').value = q.points ?? '';
  el('question').value = q.question ?? '';
  el('options').value = (q.options||[]).join('\n');
  el('correct').value = (q.correct||[]).map(x => (x+1)).join(',');
  el('image').value = q.image ?? '';
  el('explanation').value = q.explanation ?? '';
  renderList();
  setEditStatus('Kijelölve.');
}

function readForm(){
  const id = parseInt(el('qid').value, 10);
  if (!id || Number.isNaN(id)) throw new Error('Az ID kötelező (szám).');
  const options = (el('options').value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if (options.length < 2) throw new Error('Legalább 2 válaszlehetőség kell.');
  const corrRaw = (el('correct').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const correct = corrRaw.map(x => parseInt(x,10)-1).filter(x => Number.isFinite(x));
  if (!correct.length) throw new Error('Adj meg legalább 1 helyes választ (1-től indexelve).');
  for (const c of correct){
    if (c < 0 || c >= options.length) throw new Error('A helyes válasz indexe kilóg az opciók közül.');
  }
  const img = (el('image').value||'').trim();
  return {
    id,
    topic: (el('topic').value||'').trim() || 'Egyéb',
    page: parseInt(el('page').value||'0',10) || 0,
    points: parseInt(el('points').value||'1',10) || 1,
    type: (correct.length>1 ? 'többválaszos' : 'feleletválasztós'),
    question: (el('question').value||'').trim(),
    options,
    correct,
    explanation: (el('explanation').value||'').trim() || null,
    image: img || null,
    image_alt: img ? 'Ábra' : null,
    has_image: !!img
  };
}

function updateMeta(){
  BANK.count = BANK.questions.length;
  BANK.topics = Array.from(new Set(BANK.questions.map(q => q.topic).filter(Boolean))).sort();
  BANK.generated_at = new Date().toISOString();
}

function download(){
  if (!BANK) return alert('Nincs betöltött kérdésbank.');
  updateMeta();
  const blob = new Blob([JSON.stringify(BANK, null, 2)], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'questions.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

el('file').addEventListener('change', async () => {
  const f = el('file').files[0];
  if (!f) return;
  try{
    const txt = await f.text();
    BANK = normalizeBank(JSON.parse(txt));
    selIdx = BANK.questions.length ? 0 : -1;
    setStatus(`Betöltve: ${BANK.questions.length} kérdés.`);
    renderList();
    if (selIdx >= 0) select(selIdx);
  }catch(e){
    console.warn(e);
    alert('Nem sikerült betölteni a fájlt.');
  }
});

el('loadDefault').addEventListener('click', async () => {
  try{
    const r = await fetch('questions.json', {cache:'no-store'});
    if (!r.ok) throw new Error('fetch failed');
    BANK = normalizeBank(await r.json());
    selIdx = BANK.questions.length ? 0 : -1;
    setStatus(`Betöltve: ${BANK.questions.length} kérdés (questions.json).`);
    renderList();
    if (selIdx >= 0) select(selIdx);
  }catch(e){
    console.warn(e);
    alert('Nem sikerült betölteni a questions.json-t. Indítsd szerverrel (bat/sh), vagy töltsd be fájlból.');
  }
});

el('download').addEventListener('click', download);

el('add').addEventListener('click', () => {
  if (!BANK) BANK = normalizeBank({questions:[]});
  const maxId = BANK.questions.reduce((m,q)=>Math.max(m, Number(q.id)||0), 0);
  BANK.questions.push({
    id: maxId + 1, topic:'Egyéb', page:0, points:1, type:'feleletválasztós',
    question:'', options:['A','B'], correct:[0], explanation:null, image:null, image_alt:null, has_image:false
  });
  updateMeta();
  select(BANK.questions.length-1);
  renderList();
});

el('save').addEventListener('click', () => {
  if (!BANK) return alert('Nincs kérdésbank.');
  try{
    const q = readForm();
    BANK.questions[selIdx] = q;
    updateMeta();
    renderList();
    setEditStatus('Mentve.');
  }catch(e){
    alert(e.message || 'Nem sikerült menteni.');
  }
});

el('del').addEventListener('click', () => {
  if (!BANK || selIdx < 0) return;
  if (!confirm('Törlöd ezt a kérdést?')) return;
  BANK.questions.splice(selIdx,1);
  selIdx = Math.min(selIdx, BANK.questions.length-1);
  updateMeta();
  renderList();
  if (selIdx >= 0) select(selIdx);
  else setEditStatus('Nincs kiválasztott kérdés.');
});

el('reset').addEventListener('click', () => {
  if (!confirm('Töröljük a betöltött bankot?')) return;
  BANK = null; selIdx = -1;
  el('list').innerHTML = '';
  setStatus('Törölve.');
});
el('search').addEventListener('input', renderList);
</script>
</body>
</html>
